#!/bin/sh
set -e


Version="${1:-1.21.0}"

# Update security
apk add -U --no-cache --upgrade busybox

# Install build dependencies.
apk add -U --no-cache autoconf autoconf-doc automake udns udns-dev curl gcc libc-dev libevent libevent-dev libtool make openssl-dev pkgconfig postgresql-client

# Download PGBouncer
curl -o "/tmp/pgbouncer-$Version.tar.gz" -L "https://pgbouncer.github.io/downloads/files/$Version/pgbouncer-$Version.tar.gz"

# Unpack, compile
cd /tmp
tar xvfz /tmp/pgbouncer-$Version.tar.gz
cd pgbouncer-$Version
./configure --prefix=/usr --with-udns
make

# Manual install
cp pgbouncer /usr/bin
mkdir -p /etc/pgbouncer /var/log/pgbouncer /var/run/pgbouncer

# entrypoint installs the configuration, allow to write as postgres user
cp etc/pgbouncer.ini /etc/pgbouncer/pgbouncer.ini.example
cp etc/userlist.txt /etc/pgbouncer/userlist.txt.example
touch /etc/pgbouncer/userlist.txt
chown -R postgres /var/log/pgbouncer /var/run/pgbouncer /etc/pgbouncer

# Cleanup
cd /tmp
rm -rf /tmp/pgbouncer*
apk del --purge autoconf autoconf-doc automake udns-dev curl gcc libc-dev libevent-dev libtool make openssl-dev pkgconfig
