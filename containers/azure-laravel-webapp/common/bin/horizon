#!/bin/sh
set -e

export IS_HORIZON='1';
export OTEL_PHP_AUTOLOAD_ENABLED='true';
export OTEL_SERVICE_NAME="${SERVICE_NAME}-horizon"
export OTEL_SERVICE_NAMESPACE="${SERVICE_NAMESPACE}"
export OTEL_INSTANCE_ID="${INSTANCE_ID}"
export OTEL_PROPAGATORS="${OTEL_PROPAGATORS:-baggage,tracecontext}"

if [ "true" = "$OTELCOL_ENABLED" ]; then
    export OTEL_SDK_DISABLED='false'
    export OTEL_TRACES_EXPORTER='otlp'
    export OTEL_LOGS_EXPORTER='otlp'
    export OTEL_METRICS_EXPORTER='otlp'
    export OTEL_TRACES_SAMPLER='always_on'
    export OTEL_TRACES_SAMPLER=${OTEL_TRACES_SAMPLER:-parentbased_always_on}
    export OTEL_EXPORTER_OTLP_PROTOCOL='grpc'
    export OTEL_EXPORTER_OTLP_ENDPOINT='http://localhost:4317'
else
    export OTEL_SDK_DISABLED='true'
    export OTEL_TRACES_EXPORTER='none'
    export OTEL_LOGS_EXPORTER='none'
    export OTEL_METRICS_EXPORTER='none'
    export OTEL_TRACES_SAMPLER='always_off'
fi

(
    cd "$PROJECT_ROOT"
    php artisan horizon "$@"
)
