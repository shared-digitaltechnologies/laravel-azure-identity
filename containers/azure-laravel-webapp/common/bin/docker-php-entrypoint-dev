#!/bin/sh
set -e

# Run the derive
# shellcheck source=../startup/derive-env-variables.sh
. /usr/local/startup/derive-env-variables.sh

# Run custom startup scripts.
for Script in /etc/startup.d/*.sh ; do
    if [ -r "$Script" ]; then
        >&2 echo "[STARTUP] Executing startup script '$Script'"
        # shellcheck source=/dev/null
        . "$Script"
        >&2 echo "[STARTUP] ✔ Finished executing startup script '$Script'"
    fi
done

# Generate the configuration files from environment variables.
# shellcheck source=../startup/generate-configuration.sh
. /usr/local/startup/generate-configuration.sh

# Modify permissions of directories.
echo "[STARTUP-DEV] Ensure bind mount permissions are as needed."
chown -R :www-data "$PROJECT_ROOT"
chmod -R 775 "$PROJECT_ROOT/storage" "$PROJECT_ROOT/bootstrap/cache"

# Update composer dependencies.
echo "[STARTUP-DEV] Install dev dependencies"
cd "$WORKSPACE_ROOT"
composer install --ansi --no-interaction

# Run the dev startup scripts.
for Script in /etc/startup-dev.d/*.sh ; do
    if [ -r "$Script" ]; then
        >&2 echo "[STARTUP-DEV] Executing startup-dev script '$Script'"
        /bin/sh "$Script"
        >&2 echo "[STARTUP-DEV] ✔ Finished executing startup-dev script '$Script'"
    fi
done

# Show the summary of the startup.
# shellcheck source=../startup/finish-startup.sh
. /usr/local/startup/finish-startup.sh

# Execute the main command.
exec "$@"
